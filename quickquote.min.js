/*
 ****************************************
 *** ব্যবহারকারী:মোহাম্মদ মারুফ/quickquote.js: quickquote module
 ****************************************
 * Mode of invocation:     দ্রুত উক্তি যোগ
 * Active on:              main namespace
 * Config directives in:   ব্যবহারকারী:মোহাম্মদ মারুফ/quickquote.js
 * creator:                মোহাম্মদ মারুফ
 * created on:             18 January, 2023
 */
mw.loader
  .using(["mediawiki.util", "mediawiki.util.addPortletLink"])
  .then(function () {
    !(function (e, i) {
      if (
        "view" === i.config.get("wgAction") &&
        0 === i.config.get("wgNamespaceNumber") &&
        i.config.get("wgIsArticle")
      ) {
        var t = document.createElement("div");
        (t.id = "qq-container"),
          (t.className = "qq-container"),
          (t.style.display = "none"),
          document.body.appendChild(t),
          (t.innerHTML =
            '<div class="qq-popup-window"> <div class="qq-popup-header"> <div class="qq-popup-header-title">একটি উক্তি যোগ করুন</div><div class="qq-popup-button" style="background: #36c; color: #fff;" id="qq-done">সম্পন্ন</div></div><div class="qq-popup-body"> <div class="qq-popup-body"> <div class="input quote"> <div class="input-label">উক্তি</div><div class="input-field"> <textarea placeholder="উক্তি লিখুন" value="" id="qq-quote"></textarea> </div></div><div class="input ref"> <div class="input-label">তথ্যসূত্র</div><div class="input-field"> <textarea placeholder="তথ্যসূত্র" value="" id="qq-ref"></textarea> </div></div></div></div><div class="btnContainer"> <div class="qq-popup-button" style="color: #d33; border: none;" id="qq-cancel">বাতিল</div><div class="qq-popup-button" style="font-weight: normal;" id="qq-add">আরও একটি উক্তি যোগ করুন</div></div></div>');
        var n = document.getElementById("qq-add"),
          o = document.getElementById("qq-cancel"),
          d = document.getElementById("qq-done"),
          a = document.getElementById("qq-quote"),
          s = document.getElementById("qq-ref"),
          c = i.config.get("wgPageName"),
          l = [],
          u = new i.Api();
        n.addEventListener("click", function () {
          ("" === a.value && "" === s.value) ||
            (l.push({ quote: a.value, ref: s.value }),
            (a.value = ""),
            (s.value = ""));
        }),
          o.addEventListener("click", function () {
            (t.style.display = "none"), (a.value = ""), (s.value = "");
          }),
          (whereToInclude = null),
          u
            .get({ action: "parse", page: c, prop: "sections", format: "json" })
            .done(function (n) {
              if (
                (n.parse.sections.forEach(function (e) {
                  "উক্তি" === e.line && (whereToInclude = parseInt(e.index));
                }),
                null === whereToInclude)
              )
                return 0;
              e(
                i.util.addPortletLink(
                  "p-tb",
                  "#",
                  "তড়িৎ উক্তি",
                  "t-quickquote",
                  "দ্রুত উক্তি যোগ"
                )
              ).click(function () {
                "none" === t.style.display
                  ? (t.style.display = "flex")
                  : (t.style.display = "none");
              }),
                d.addEventListener("click", function () {
                  t.style.display = "none";
                  var n = "";
                  if ("" === a.value && "" === s.value) {
                    if (0 !== l.length)
                      for (var o = 0; o < l.length; o++)
                        n += "\n* " + l[o].quote + "\n** " + l[o].ref;
                  } else {
                    l.push({ quote: a.value, ref: s.value });
                    for (o = 0; o < l.length; o++)
                      n += "\n* " + l[o].quote + "\n** " + l[o].ref;
                  }
                  n
                    ? (function (e, i, t, n) {
                        var o = {
                          action: "edit",
                          title: c,
                          section: e,
                          summary:
                            "[[ব্যবহারকারী:মোহাম্মদ মারুফ/quickquote|quickquote]] ব্যবহার করে " +
                            t +
                            "টি উক্তি যোগ করা হয়েছে",
                        };
                        !(function (e, i) {
                          var t = {
                            action: "parse",
                            page: c,
                            prop: "wikitext",
                            format: "json",
                            section: e,
                            disabletoc: 1,
                            formatversion: "2",
                          };
                          u.get(t).done(function (e) {
                            i(e.parse.wikitext);
                          });
                        })(e, function (e) {
                          (o.text = e + i),
                            u.postWithToken("csrf", o).done(function (e) {
                              "Success" === e.edit.result
                                ? n(!0)
                                : n(e.edit.result);
                            });
                        });
                      })(whereToInclude, n, l.length, function (t) {
                        !0 === t
                          ? (i.notify(
                              e(
                                '<div class="qq-msg-container"><img src="https://upload.wikimedia.org/wikipedia/commons/2/28/Green_check_icon_with_gradient.svg" /><span>উক্তি যোগ করা হয়েছে</span></div>'
                              ),
                              { type: "success", autoHideSeconds: 1 }
                            ),
                            setTimeout(function () {
                              location.reload();
                            }, 1e3))
                          : i.notify(
                              e(
                                '<div class="qq-msg-container"><img src="https://upload.wikimedia.org/wikipedia/commons/5/5f/Red_X.svg" /><span>' +
                                  t +
                                  "</span></div>"
                              ),
                              { type: "error", autoHideSeconds: 3 }
                            );
                      })
                    : i.notify(
                        e(
                          '<div class="qq-msg-container"><img src="https://upload.wikimedia.org/wikipedia/commons/2/25/Info_icon-72a7cf.svg" /><span>উক্তি যোগ করা হয়নি</span></div>'
                        ),
                        { type: "info", autoHideSeconds: 1 }
                      );
                });
            });
      }
    })(jQuery, mw);
  });
